<!DOCTYPE html>
<html>
<head>
    <title>知识图谱</title>
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
 
<body>
<div id="main" style="width:1000px;height:800px"></div>

<script type="text/javascript">
    var myChart = echarts.init(document.getElementById('main'));
    myChart.showLoading();
    var nodes;
    var links1;
    var category1;
    var categories = [];
    $.get('data.json').done(function (data) {
        nodes=data.nodes;
        links1=data.links;
        category1=data.categories;
    });
    setTimeout(function (){
        for (var i = 0; i < category1; i++) {
            categories[i] = {
                name: '类目' + i
            };
        }
        myChart.hideLoading();
        option = {
            // 图的标题
            title: {
                text: '知识图谱'
            },
            // 提示框的配置
            tooltip: {
                formatter: function (x) {
                    return x.data.des;
                }
            },

            // 工具箱
            toolbox: {
                // 显示工具箱
                show: true,
                feature: {
                    mark: {
                        show: true
                    },
                    // 还原
                    restore: {
                        show: true,
                    },
                    // 保存为图片
                    saveAsImage: {
                        show: true
                    },
                    magicType: {
                        show: true
                    }
                }
            },
            legend: [{
                // selectedMode: 'single',
                data: categories.map(function (a) {
                    return a.name;
                })
            }],
            series: [{
                id:'COIN',
                type: 'graph', // 类型:关系图
                //layout: 'force', //图的布局，类型为力导图
                //layout:'circular',//环形布局
                layout: 'none',
                symbolSize: 40, // 调整节点的大小
                roam: true, // 是否开启鼠标缩放和平移漫游。默认不开启。如果只想要开启缩放或者平移,可以设置成 'scale' 或者 'move'。设置成 true 为都开启
                edgeSymbol: ['circle', 'arrow'],
                edgeSymbolSize: [2, 10],
                smooth: false,   //关键点，为true是不支持虚线的，实线就用true
                edgeLabel: {
                    normal: {
                        textStyle: {
                            fontSize: 20
                        }
                    }
                },
                force: {
                    repulsion: 2500,
                    edgeLength: [10, 50]
                },
                draggable: true,
                lineStyle: {
                    normal: {
                        width: 2,
                        color: '#4b565b',
                    },

                },
                edgeLabel: {
                    normal: {
                        show: true,
                        formatter: function (x) {
                            return x.data.name;
                        }
                    }
                },
                label: {
                    normal: {
                        show: true,
                        textStyle: {}
                    }
                },
                // // 数据,需要从外面读取
                data:nodes,
                links:links1,
                categories: categories,


            }],

        };
        myChart.setOption(option);
        console.log(nodes);
        initNode();

        myChart.on('restore',function () {
            initNode();
            updatePosition();
        });
        myChart.on('resize',function () {
            initNode();
            updatePosition();
        });

    },3000);


    function onPointDragging(dataIndex, pos) {
       //修改节点的x,y值并重新绘制
        nodes[dataIndex].x = myChart.convertFromPixel('series', pos)[0];
        nodes[dataIndex].y = myChart.convertFromPixel('series', pos)[1];
        myChart.setOption({
            series: [{
                data: nodes
            }]
        });
        updatePosition();
    }

    function updatePosition() {
        //更新覆盖在节点上的值
        myChart.setOption({
            graphic: nodes.map(function (item, dataIndex) {
                return {
                    position: myChart.convertToPixel('series', [item.x,item.y])
                };
            })
        });
    }

    function initNode(){
        //获取原始节点位置，并在上面覆盖透明的圆
        $.get('data.json').done(function (data) {
            myChart.setOption({
                graphic: data.nodes.map(function (item, dataIndex) {
                    return {
                        type: 'circle',
                        position: myChart.convertToPixel('series', [item.x,item.y]),
                        shape: {
                            r: item.symbolSize / 2
                        },
                        invisible: true,//透明
                        draggable: true,
                        ondrag: function (dx, dy) {
                            onPointDragging(dataIndex, [this.x, this.y]);
                        },
                        z: 100
                    }
                })
            });
        })
    }

</script>
</body>
</html>
    